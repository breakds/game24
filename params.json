{"name":"Game24","tagline":"A demonstration of building Common Lisp webapps with lazy-bone","body":"game24\r\n======\r\n\r\nA lazy-bone Tutorial.\r\n\r\n### Introduction\r\n\r\n[lazy-bone](https://github.com/breakds/lazy-bone) is a Common Lisp web application framework, mainly based on [Parenscript](http://common-lisp.net/project/parenscript/) and [Backbone.js](http://backbonejs.org/). This tutorial demonstrates building a web application that solves the 24 Game with lazy-bone. All the code (both server side and client side) resides in one single common lisp file, and you should expect an effortless trip reading this article. \r\n\r\nThat says, if you find any difficulties understanding this article, it must be my fault. Feel free to contact me through GitHub or email `BreakDS@g(oogle)mail.com`.\r\n\r\n\r\nThe final web app will look like [this](http://ec2-54-242-26-216.compute-1.amazonaws.com:9702/game24).\r\n\r\n### About the 24 Game\r\n\r\nThe 24 Game is about finding an arithmetic expression that results 24 with four given integer, where only + - * / are allowed. Please refer to [Wikipedia](http://en.wikipedia.org/wiki/24_Game) for more information.\r\n\r\n### Step 0: Preparation\r\n\r\nIn this tiny project we need a Common Lisp environment (e.g. Emacs + [Slime](http://common-lisp.net/project/slime/)) and some Common Lisp Libraries:\r\n\r\n* [Hunchentoot](http://weitz.de/hunchentoot/) for web server\r\n* [jsown](https://github.com/madnificent/jsown) for Json manipulations\r\n* [html-template](http://weitz.de/html-template/) for dependecy \r\n* [basicl](https://github.com/breakds/basicl) for dependency\r\n* and of course, [lazy-bone](https://github.com/breakds/lazy-bone)\r\n\r\nI would recommend [quicklisp](http://www.quicklisp.org/beta/) for Common Lisp library management so that you don't have to get your hand dirty. Just have [basicl](https://github.com/breakds/basicl) and [lazy-bone](https://github.com/breakds/lazy-bone) in your quicklisp local-projects directory and the depended libraries will be automatically downloaded and configured.\r\n\r\n\r\n### Step 1: The 24 Game Solver\r\n\r\nIn this section we create the solver that find the expressions that hits 24 with a list of integers. This part is totally not related to lazy-bone, and will be used in the backend of the web application.\r\n\r\nThere are many algorithms that solves the 24 Game. The basic idea is to generate all the possible expressions, and filter out the ones that does not have a result of 24. For example, consider the 2 expressions generated from the four integers 3 7 1 2:\r\n\r\n* (+ (* 3 7) 1 2)\r\n* (+ 3 7 1 2)\r\n\r\nThe first one hits 24 and will be kept:\r\n```common-lisp\r\nCL-USER> (+ (* 3 7) 1 2)\r\n24\r\n```\r\n\r\nAnd the second one is going to be filtered out:\r\n```common-lisp\r\nCL-USER> (+ 3 7 1 2)\r\n13\r\n```\r\nIt is easy to exhausted all the possible expressions iterately. Consier an integer list x, gen(x) should work as \r\n\r\n1. find all the 2-partitions of x\r\n2. for each patition (a b), push the below 6 expressions into result\r\n   * gen(a) + gen(b)\r\n   * gen(a) * gen(b)\r\n   * gen(a) - gen(b)\r\n   * gen(b) - gen(a)\r\n   * gen(a) / gen(b)\r\n   * gen(b) / gen(a)\r\n3. the recursion stops when x is a single integer, in the case x itself will be returned\r\n\r\n\r\n#### the Partition Generator\r\n\r\nOkay so much for the explanation, let's write some actual code. The partition generator is a function that produce a closure for a give integer list: partition-generator\r\n```common-lisp\r\n(defun partition-generator (lst)\r\n  \"return a generator that generates a partition of lst one at a time\"\r\n  (alet ()\r\n    (lambda ()\r\n      (funcall (alambda (lst left right cont)\r\n                 (block result\r\n                   (if (null lst)\r\n                       (return-from result\r\n                         (when left\r\n                           (setq this cont)\r\n                           (list left right)))\r\n                       (self (cdr lst)\r\n                             (cons (car lst) left)\r\n                             right\r\n                             (lambda ()\r\n                               (self (cdr lst)\r\n                                     left\r\n                                     (cons (car lst) right)\r\n                                     cont))))))\r\n               (cdr lst) nil (list (car lst)) \r\n               (lambda () nil)))))\r\n```\r\n\r\nTo test the function:\r\n\r\n```common-lisp\r\nGAME24> (setq next (partion-generator '(1 2 3 4)))\r\n#<CLOSURE (LAMBDA (&REST #:G15) :IN PARTITION-GENERATOR) {1005FB6CCB}>\r\nGAME24> (funcall next)\r\n((4 3 2) (1))\r\nGAME24> (funcall next)\r\n((3 2) (4 1))\r\nGAME24> (funcall next)\r\n((4 2) (3 1))\r\nGAME24> (funcall next)\r\n((2) (4 3 1))\r\nGAME24> (funcall next)\r\n((4 3) (2 1))\r\nGAME24> (funcall next)\r\n((3) (4 2 1))\r\nGAME24> (funcall next)\r\n((4) (3 2 1))\r\nGAME24> (funcall next)\r\nNIL\r\n```\r\nNote that the closure generates one partition per call, and will produce nil after all the parititons are generated (plesae recall yeild in python and continuation passing style programming).\r\n\r\n#### The solver\r\n\r\nThe solver is straigt-forward as described above:\r\n\r\n```common-lisp\r\n(defmacro op (symb op-1 op-2)\r\n  `(lambda (a b) (list ',symb ,op-1 ,op-2)))\r\n\r\n(defun calc (exp)\r\n  (aif (ignore-errors (eval exp)) it 0))\r\n\r\n(defun solve (lst)\r\n  (labels ((gen (lst next accu)\r\n             (case (length lst)\r\n               (1 lst)\r\n               (t (if next\r\n                      (aif (funcall next)\r\n                           (gen lst next\r\n                                (append \r\n                                 (map-cartesian (lambda (x y z)\r\n                                                  (funcall z x y))\r\n                                                (gen (car it) nil nil)\r\n                                                (gen (cadr it) nil nil)\r\n                                                (list (op + a b)\r\n                                                      (op * a b)\r\n                                                      (op / a b)\r\n                                                      (op / b a)\r\n                                                      (op - a b)\r\n                                                      (op - b a)))\r\n                                 accu))\r\n                           accu)\r\n                      (gen lst (partition-generator lst) accu))))))\r\n    (remove-if-not (lambda (x) (= (calc x) 24)) (gen lst nil nil))))\r\n```\r\n\r\n**Notes**: The macro `map-cartesian` is a analogical to `mapcar`. In fact, it is the `mapcar` on the cartesian product of its list arguments. `map-cartesian` is defined in the library [basicl](https://github.com/breakds/basicl), and the code is given in the appendix. Another spot worth noticing is that the constructed expressions might involve division by zero, therefore we need to apply `ignore-erros` to the `(eval exp)` in the definition of `calc`. We force the evaluation of \"division-by-zero\" expression to be 0 so that it yeilds an integer that is not equal to 24.\r\n\r\n\r\n### Step 2: A Blank Web Page\r\n\r\nProgramming is usually an iterative process and we are definitely going to stick to this tradition. To define a web application with [lazy-bone](https://github.com/breakds/lazy-bone), we call the macro `define-simple-app`:\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n     :uri \"/game24\"\r\n     :port 9702\r\n     :libs (;; JQuery\r\n  \t        \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  ;; the parenscript code goes here)\r\n```\r\n\r\nThe above code defines a web-application called \"game24-app\". Most of the parameters are self-explained. With such configuration, the web application can be visited by typing \"localhost:9702/game24\" in your web browser once it is started. This piece of code implicitly defines two function: `start-server` and `stop-server`, where usage are quite clear:\r\n\r\n```common-lisp\r\nGAME24> (start-server)\r\nserver started.\r\nNIL\r\n;; Now you can open your web browser and type \"localhost:9702/game24\"\r\n```\r\n\r\nWe'll going to write some parenscript code in the place indicated with corresponding comment. Before that, you'll find nothing but a blank webpage in your web browser.\r\n\r\n\r\n### Step 3: First Widget - A Select Box\r\n\r\nNow we are going to put a select box in the web page. Whether you are familiar with Backbone.js or its millions MVC counterparts, you are reminded that in a MVC framework (Okay, Backbone.js is not quite a strict MVC framework ... let it be ..) we define models to hold the data and define views (of models) to be shown in the web page. [lazy-bone](https://github.com/breakds/lazy-bone) follows the same path.\r\n\r\nDefining the models and views are just like defining functions in common-lisp. The following code defines the select box for number selection:\r\n\r\n```common-lisp\r\n(def-model number-set-model\r\n    ((defaults (properties :selected 0))))\r\n\r\n(def-view number-set-view\r\n    ((tag-name \"select\")\r\n     (template \"<option>1</option><option>2</option><option>3</option>\")\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n```\r\n\r\nThe body of view and model definition is a list of attribute definition, where each attribute definition specifies an attribute name and an attribute value. For example, in the above code segment, the model `number-set-model` has attribute `defaults` specified, whose value is `{ selected : }`. The view `number-set-view` has several attributes specified, where the `tag-name` is \"select\" (once instantiated, it becomes a \"<select>\" in the DOM), the template is several options (once instantiated, the content between \"<select>\" and \"</select>\"), `initialize` will be a lambda function that appends the \"<select>\" html segment to its parent node (`lazy-init` is a macro that defines a lambda function that also execute initialization code of its super class), and finally, `render` is a lambda function that actually do the render job and return `this`. Note that we specify values for those attributes in **parenscript**, which means that they do not get evaluted but will be translated to javascript in the future.\r\n\r\nWe then plug this view into our web application. Append those parenscript code in our web application definition:\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n     :uri \"/game24\"\r\n     :port 9702\r\n     :libs (;; JQuery\r\n            \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  ;; appende parenscript code\r\n  (defvar number-set-0 (duplicate number-set-model))\r\n  (defvar number-set-view-0 (duplicate number-set-view\r\n                                       :model number-set-0))) \r\n;; number-set-view-0 is an instance of number-set-view whose corresponding model is number-set-0.\r\n```\r\n\r\nThose two line simply means we have number-set-0 as an instance of number-set-model as we defined above, and an instance of number-set-view called number-set-view-0. The macro `duplicate` accepts keyword parameter list as shown and commented in the code.\r\n\r\n\r\nOpen your browser again and you'll see a select box there now.\r\n\r\n\r\n### Step 4: Embed Some Common Lisp Code\r\n\r\nTake another look at the view definition code from the above section.\r\n\r\n```common-lisp\r\n(def-view number-set-view\r\n    ((tag-name \"select\")\r\n     (template \"<option>1</option><option>2</option><option>3</option>\")\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n```\r\n\r\nI believe I am not the only one consider the \"<option>...\" string tedious. What if we want 10 options? 100? Here comes one benefit of writing parenscript code: we can embed common lisp code in it so that it gets evaluted before translated to javascript. With `eval-lisp`, the above code can be made to support option 1 through 9 as\r\n\r\n```common-lisp\r\n(def-view number-set-view\r\n    ((tag-name \"select\")\r\n     (template (eval-lisp \r\n                (funcall (alambda (k accu)\r\n                           (if (= k 0) accu\r\n                               (self (1- k)\r\n                                     (mkstr \"<option>\" k \"</option>\" accu))))\r\n                         9 \"\")))\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n```\r\n\r\nAnd we can do even better! If we make 9 a special variable, we can then modify it even when the web server is running.\r\n\r\n```common-lisp\r\n(defparameter *max-number* 9)\r\n\r\n(def-view number-set-view\r\n    ((tag-name \"select\")\r\n     (template (eval-lisp \r\n                (funcall (alambda (k accu)\r\n                           (if (= k 0) accu\r\n                               (self (1- k)\r\n                                     (mkstr \"<option>\" k \"</option>\" accu))))\r\n                         *max-number* \"\")))\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n```\r\n\r\n### Step 5: Four Select Boxes\r\n\r\nDid I forget to say we have to have four select boxes for the 24 Game? Sounds easy enough:\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n     :uri \"/game24\"\r\n     :port 9702\r\n     :libs (;; JQuery\r\n            \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  ;; parenscript code starts here\r\n  (defvar number-set-0 (duplicate number-set-model))\r\n  (defvar number-set-view-0 (duplicate number-set-view\r\n                                       :model number-set-0))\r\n  (defvar number-set-1 (duplicate number-set-model))\r\n  (defvar number-set-view-1 (duplicate number-set-view\r\n                                       :model number-set-1))\r\n  (defvar number-set-2 (duplicate number-set-model))\r\n  (defvar number-set-view-2 (duplicate number-set-view\r\n                                       :model number-set-2))\r\n  (defvar number-set-3 (duplicate number-set-model))\r\n  (defvar number-set-view-3 (duplicate number-set-view\r\n                                       :model number-set-3)))\r\n```\r\n\r\nOh no, I smell something really ordorous >_<. Glad we don't have to do it for 100 times. But what if we do? \r\n\r\n\r\nThough not necessary, I am going to demonstrate another trick of parenscript here, the `macrolet`. we can first use `macrolet` to define a inline macro, and apply it for four times:\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n            :uri \"/game24\"\r\n            :port 9702\r\n            :libs (;; JQuery\r\n            \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  (macrolet ((place-view (id)\r\n               `(progn (defvar ,(symb 'number-set- id) \r\n                         (duplicate number-set-model))\r\n                       (defvar ,(symb 'number-set-view- id)\r\n                         (duplicate number-set-view\r\n                                    :model number-set-0)))))\r\n    (place-view 0)\r\n    (place-view 1)\r\n    (place-view 2)\r\n    (place-view 3)))\r\n```\r\n\r\n\r\n### Step 6: Intraction with Model\r\n\r\nWondering why we have a property called \"selected\" in our model definition? You should. That is a property which will be changed if you change the selected integer in the select box. We have to make a connecton between the view and its model. \r\n\r\nThe HTML tag \"<select>\" will emit an event \"changed\" when the user alters the selection. Appending some attribute slots in our view definition will create a callback for this event:\r\n\r\n```common-lisp\r\n(def-view number-set-view\r\n    ((tag-name \"select\")\r\n     (template (eval-lisp \r\n                (funcall (alambda (k accu)\r\n                           (if (= k 0) accu\r\n                               (self (1- k)\r\n                                     (mkstr \"<option>\" k \"</option>\" accu))))\r\n                         *max-number* \"\")))\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))\r\n     (events (create \"change\" \"changed\"))\r\n     (changed (lambda ()\r\n                (@set \"selected\" (*number (@. this $el (val))))\r\n                ;; for debug\r\n                (trace (@get \"selected\"))\r\n                nil))))\r\n```\r\n\r\n**Note** that `create` in parenscript does object creation. That says, `(create a b c d)` will be translated into `{ a: b, c: d}` in javascript. There are three new macros introduced here\r\n\r\n* `@set` sets the specified property of the view's model. \r\n* `trace` prints its argument to the console.\r\n* `@.` and `@` are the chain macros that mimic the `.` in javascript. `(@. a (b c) d (e f))` translates to `a.b(c).d.e(f)` in javascript. \r\n\r\n\r\nTest the web app in your browser now with the console open. Whenever you modify the selection of any select box, its model's new \"selected\" value will be printed in the console.\r\n\r\n\r\n### Step 7: A Submit Button\r\n\r\n```common-lisp\r\n(def-model submit-model\r\n    ((defaults (properties :vent undefined))))\r\n\r\n(def-view submit-button\r\n    ((tag-name \"button\")\r\n     (template \"Submit\")\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n```\r\n\r\nNothing new here. The property `vent` will prove its usefulness later. Add some code to the web app definition so that the button will be shown:\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n            :uri \"/game24\"\r\n            :port 9702\r\n            :libs (;; JQuery\r\n            \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  (macrolet ((place-view (id)\r\n               `(progn (defvar ,(symb 'number-set- id) \r\n                         (duplicate number-set-model))\r\n                       (defvar ,(symb 'number-set-view- id)\r\n                         (duplicate number-set-view\r\n                                    :model number-set-0)))))\r\n    (place-view 0)\r\n    (place-view 1)\r\n    (place-view 2)\r\n    (place-view 3))\r\n  (defvar button (duplicate submit-button\r\n                            :model (duplicate submit-model))))\r\n```\r\n\r\nYou'll see the button in your browser if you test it now. The only problem you see might be that no matter how hard you strike the button, nothing happens. Well, that's forgivable. After all, we haven't associated its \"click\" event to anything.\r\n\r\n### Step 8: A Global Event Manager\r\n\r\nWe are now going to define a global event manager called \"vent\" that listen to registered events and perform some registered callback work. The following piece of code in the very beginning of the parenscript section translates (to English) that: when never I heard about the event \"submit-event\", I print \"ok\" to the console.\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n            :uri \"/game24\"\r\n            :port 9702\r\n            :libs (;; JQuery\r\n            \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  ;; parenscript starts here\r\n  (create-event-manager vent\r\n                        \"submit-event\" (lambda ()\r\n                                         (trace \"ok\")))\r\n  (macrolet ((place-view (id)\r\n               `(progn (defvar ,(symb 'number-set- id) \r\n                         (duplicate number-set-model))\r\n                       (defvar ,(symb 'number-set-view- id)\r\n                         (duplicate number-set-view\r\n                                    :model number-set-0)))))\r\n    (place-view 0)\r\n    (place-view 1)\r\n    (place-view 2)\r\n    (place-view 3))\r\n  (defvar button (duplicate submit-button\r\n                            :model (duplicate submit-model\r\n                                              :vent vent)))) ;; pass the global manager to the model\r\n```\r\n\r\nNot so hard, huh? Note that we also pass the global manager \"vent\" to the \"vent\" property of the button's model. We can now control the button to emit a \"submit-event\" to the global event manager whenever clicked. The same \"events\" attribute trick will do. Modify the defnition of the button as:\r\n\r\n```common-lisp\r\n(def-model submit-model\r\n    ((defaults (properties :vent undefined))))\r\n\r\n(def-view submit-button\r\n    ((tag-name \"button\")\r\n     (template \"Submit\")\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))\r\n     (events (create \"click\" \"clicked\"))\r\n     (clicked (lambda ()\r\n                (@. (@get \"vent\") \r\n                    (trigger \"submit-event\"))))))\r\n```\r\n\r\n**Note** a new macro is introduced here called `@get`. It's similar to `@set` except for that it reads the property instead of writing to it.\r\n\r\n\r\nNow you should be able to see \"ok\" being printed in the console while click the button. \r\n\r\n\r\n### Step 9: The Solution Table\r\n\r\nThe solution table will be an HTML \"<table>\" tag displaying the solutions to the 24 Game. Defining them is similary to the button and the select box, except for that the model is actually a collection instead of a single model. The following code will accomplish the task:\r\n\r\n```common-lisp\r\n(def-model single-solution-model\r\n    ((defaults (properties :solution \"\"))))\r\n\r\n(def-view single-solution-view\r\n    ((tag-name \"tr\")\r\n     (template \"<td><%=solution%></td>\")\r\n     (initialize (lazy-init\r\n                  (append-to-parent)))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n\r\n(def-collection solutions-model\r\n    ((model single-solution-model)))\r\n\r\n(def-collection-view solutions-view\r\n    ((tag-name \"table\")\r\n     (sub-view single-solution-view)\r\n     (initialize (lazy-init\r\n                  (append-to-parent)\r\n                  (@. this model list (each (@ this lazy-add)))))\r\n     (render (lambda ()\r\n               (render-from-model)\r\n               this))))\r\n```\r\n\r\n**Note** that there are several new attributes here in the `collection` definition and the `collection-view` definition. A collection is actually a list of its sub model isntances, therefore we need to specify its sub model by setting the attribute \"model\". Instantiate a collection view needs also to instantiate the view for the sub models, which requires specify the \"sub-view\" attribute. You might also want to refer to [Backbone.js: Collection](http://backbonejs.org/#Collection).\r\n\r\nYou can then place the collection-view in your web application:\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n            :uri \"/game24\"\r\n            :port 9702\r\n            :libs (;; JQuery\r\n            \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t        ;; underscore.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n\t\t        ;; backbone.js\r\n            \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  ;; parenscript starts here\r\n  (create-event-manager vent\r\n                        \"submit-event\" (lambda ()\r\n                                         (trace \"ok\")))\r\n  (macrolet ((place-view (id)\r\n               `(progn (defvar ,(symb 'number-set- id) \r\n                         (duplicate number-set-model))\r\n                       (defvar ,(symb 'number-set-view- id)\r\n                         (duplicate number-set-view\r\n                                    :model number-set-0)))))\r\n    (place-view 0)\r\n    (place-view 1)\r\n    (place-view 2)\r\n    (place-view 3))\r\n  (defvar button (duplicate submit-button\r\n                            :model (duplicate submit-model\r\n                                              :vent vent)))\r\n  \r\n  \r\n  (defvar solutions (duplicate solutions-model)) ;; the solution table's model\r\n\r\n  (defvar solution-list (duplicate solutions-view \r\n                                   :model solutions))) ;; the solution table's view                                              \r\n```\r\n\r\nBut **do not** expect to see anything in your browser now. The solution model (collection) `solutions` is still empty for this moment.\r\n\r\n\r\n### Step 10: Fetch the Solutions from the Server\r\n\r\nYou might want to ask, hey, where is ... the server? Do we write the server somewhere else?\r\n\r\nThe answer is .. Nope, we are just going to write it, here inside the parenscript code of your web app.\r\n\r\nAnd you hear me clearly.\r\n\r\nThe macro `@fetch` does the job exactly. I am going to first illustrate its usage by a simple example:\r\n\r\n```common-lisp\r\n(@fetch obj \r\n        :url \"/game24/test\"\r\n        :type \"post\"\r\n        :server (let ((a 12)\r\n                      (b \"sum\")\r\n                      (c 3))\r\n                  (setf (session-value 'result) (+ a c)) ;; this is server common lisp code\r\n                  (format nil \"~a: ~a\" b (session-value 'result)))) ;; this is server common lisp code.\r\n```\r\n\r\nThe above parenscript code sends a post request the url \"/game24/test\" and wait for a response to update the content of the a model instance called \"obj\". The `:server` attribute is actually trickier and **important** here: it accepts a let form. This let form is special because all its body will be server code that executes inside a Hunchentoot handler. The binding list, on the other hand, gets bind on the client side. However, the let form doesn't look special though, since you can access the binded variables in the body just as they gets bound on the server side!\r\n\r\n\r\nApply this trick to our web application, the code becomes\r\n\r\n```common-lisp\r\n(define-simple-app game24-app\r\n    (:title \"Game 24\"\r\n            :uri \"/game24\"\r\n            :port 9702\r\n            :libs (;; JQuery from Google Ajax cdn\r\n\t\t   \"http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js\"\r\n\t\t   ;; underscore.js from cdnjs\r\n\t\t   \"http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js\"\r\n                   ;; backbone.js from cdnjs\r\n                   \"http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js\"))\r\n  (create-event-manager vent\r\n                        \"submit-event\" (lambda ()\r\n                                         (@fetch (@ solutions list)\r\n                                                 :url \"/game24/calc\"\r\n                                                 :type \"post\"\r\n                                                 :server (let ((numbers (array (@. number-set-0 (get \"selected\"))\r\n                                                                               (@. number-set-1 (get \"selected\"))\r\n                                                                               (@. number-set-2 (get \"selected\"))\r\n                                                                               (@. number-set-3 (get \"selected\")))))\r\n                                                           (let ((result (solve numbers)))\r\n                                                             (jsown:to-json (mapcar (lambda (x) `(:obj (\"solution\" ,(format nil \"solution: ~a\" x))))\r\n                                                                                    result)))))))\r\n  (macrolet ((place-view (id)\r\n               `(progn (defvar ,(symb 'number-set- id) \r\n                         (duplicate number-set-model))\r\n                       (defvar ,(symb 'number-set-view- id)\r\n                         (duplicate number-set-view\r\n                                    :model ,(symb 'number-set- id))))))\r\n    (place-view 0)\r\n    (place-view 1)\r\n    (place-view 2)\r\n    (place-view 3))\r\n  (defvar button (duplicate submit-button\r\n                            :model (duplicate submit-model\r\n                                              :vent vent)))\r\n\r\n  (defvar solutions (duplicate solutions-model))\r\n\r\n  (defvar solution-list (duplicate solutions-view \r\n                                   :model solutions)))\r\n```\r\n\r\n**Note** that the \"submit-event\" is now handled differently. The `@fetch` is used similarly here, except for that the server body now returns a json object that updates the content of our solution model `solutions`.\r\n\r\nNow we have built the web application and you can play with it in the browser with ease.\r\n\r\n\r\n### Step 11: A Final Improvement\r\n\r\nYou might have notice that there can be solutions that are almost identical. We design the following function `normalize-exp` to help solve this problem:\r\n\r\n```common-lisp\r\n(defun normalize-exp (exp)\r\n  (if (atom exp) exp\r\n      (let* ((opt (and (member (car exp) '(+ *)) (car exp))))\r\n        (cons (car exp) \r\n              (sort (reduce (lambda (y x) \r\n                              (let ((norm (normalize-exp x)))\r\n                                (or (and (consp norm) (eq opt (car norm))\r\n                                         (append (cdr norm) y))\r\n                                    (cons norm y))))\r\n                            (cdr exp) :initial-value nil)\r\n                    #'string> :key #'write-to-string)))))\r\n```\r\n\r\nNormalized with `normalize-exp`, similar solutions will be exactly identical. Common Lisp utility function `remove-duplicates` can then filter the solution list easily. Modify the line in your web application server part that calls `solve`\r\n\r\n```common-lisp\r\n(let ((result (solve numbers)))\r\n   ...)\r\n```\r\n\r\nto be \r\n\r\n```common-lisp\r\n(let ((result (remove-duplicates (mapcar #'normalize-exp \r\n                                         (solve numbers))\r\n                                 :test #'equal)))\r\n   ....)\r\n```\r\n\r\nwill do the job.\r\n\r\n\r\n\r\n### Appendix: Implementation of map-cartesian\r\n\r\n```common-lisp\r\n(defmacro map-cartesian (fun &rest lists)\r\n  (labels ((reduce-iter (x-vars y-var remain)\r\n             (with-gensyms (x y)\r\n               `(reduce (lambda (,y ,x)\r\n                          ,(case (length remain)\r\n                                 (1 `(cons (funcall ,fun\r\n                                                    ,@(reverse x-vars)\r\n                                                    ,x)\r\n                                           ,y))\r\n                                 (t (reduce-iter (cons x x-vars)\r\n                                                 y\r\n                                                 (cdr remain)))))\r\n                        ,(car remain)\r\n                        :initial-value ,y-var))))\r\n    (reduce-iter nil nil lists)))\r\n```\r\n   \r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}